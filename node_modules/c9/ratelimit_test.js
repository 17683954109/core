"use server";

require("c9/inline-mocha")(module);

var ratelimit = require("./ratelimit");
var assert = require("assert");

describe("ratelimit", function() {
    it("Should limit based on key", function (done) {
        var limiter = ratelimit("test", 10, 1);
        limiter({params: {test: 1}}, null, function (err) {
            assert(!err, err);
            limiter({params: {test: 1}}, null, function (err) {
                assert(err);
                assert.equal(err.code, 429);
                done();
            });
        });
    });
    
     it("Should work again after a delay", function (done) {
        var limiter = ratelimit("test", 10, 1);
        limiter({params: {test: 1}}, null, function (err) {
            assert(!err, err);
            setTimeout(function() {
                limiter({params: {test: 1}}, null, function (err) {
                    assert(!err, err);
                    done();
                });
            }, 15);
        });
    });
});